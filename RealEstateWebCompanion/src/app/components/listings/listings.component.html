<div class="listings">
  <div class="header">
    <h2>Listings Management</h2>
    <div class="actions">
      <button class="btn btn-success" (click)="addRow()">
        + Add Listing
      </button>
      @if (googleDriveFolderUrl) {
        <div class="button-group">
          <button class="btn btn-primary" (click)="exportData()" title="Export Apartments data to local file">
            üì§ Export from Listings Manager
          </button>
          <button class="btn btn-success" (click)="openGoogleDriveToUpload()" title="Open Google Drive to upload exported file">
            ‚¨ÜÔ∏è Put into SeguinDev Drive
          </button>
        </div>
        <div class="button-group">
          <button class="btn btn-primary" (click)="quickImportFromSeguinDev()" title="Download Apartments file from SeguinDev Google Drive">
            üì• Get from SeguinDev Drive
          </button>
          <label class="btn btn-secondary" title="Import Apartments data from local file">
            üìã Import to Listings Manager
            <input type="file" accept=".json" (change)="importData($event)" style="display: none;">
          </label>
        </div>
      } @else {
        <button class="btn btn-primary" (click)="exportData()">
          Export Apartments (JSON)
        </button>
        <label class="btn btn-secondary">
          Import Apartments (JSON)
          <input type="file" accept=".json" (change)="importData($event)" style="display: none;">
        </label>
      }
      @if (isDanielSeguin) {
        <button class="btn btn-warning" (click)="resetToDefault()">
          Load Demo Listings from California, USA - Add 100 Listings
        </button>
      }
    </div>
  </div>
  <ag-grid-angular
    style="width: 100%; height: 800px;"
    class="ag-theme-alpine"
    [rowData]="rowData"
    [columnDefs]="colDefs"
    [defaultColDef]="defaultColDef"
    [gridOptions]="gridOptions"
    (gridReady)="onGridReady($event)"
    (cellValueChanged)="onCellValueChanged($event)"
  />
  
  <!-- Edit Modal -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Apartment Details</h3>
        <button class="close-btn" (click)="closeEditModal()">√ó</button>
      </div>
      
      <!-- Tabs -->
      <div class="tabs">
        <button 
          class="tab-btn" 
          [class.active]="activeTab === 'basic'"
          (click)="setActiveTab('basic')">
          Basic Info
        </button>
        <button 
          class="tab-btn" 
          [class.active]="activeTab === 'details'"
          (click)="setActiveTab('details')">
          Details
        </button>
        <button 
          class="tab-btn" 
          [class.active]="activeTab === 'features'"
          (click)="setActiveTab('features')">
          Features
        </button>
        <button 
          class="tab-btn" 
          [class.active]="activeTab === 'images'"
          (click)="setActiveTab('images')">
          Images
        </button>
      </div>
      
      <div class="modal-body" *ngIf="editingApartment">
        <!-- Basic Info Tab -->
        <div class="tab-content" *ngIf="activeTab === 'basic'">
          <div class="form-grid">
            <div class="form-group">
              <label>ID:</label>
              <input type="text" [(ngModel)]="editingApartment.id" readonly>
            </div>
            
            <div class="form-group">
              <label>Title (French):</label>
              <input type="text" [(ngModel)]="editingApartment.title">
            </div>
            
            <div class="form-group">
              <label>Title (English):</label>
              <input type="text" [(ngModel)]="editingApartment.titleEn">
            </div>
            
            <div class="form-group">
              <label>Unit Type *:</label>
              <select [(ngModel)]="editingApartment.unit_type_name">
                <option value="">Select unit type</option>
                <option *ngFor="let type of availableUnitTypes" [value]="type">{{ type }}</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Bathrooms:</label>
              <input type="number" step="0.5" [(ngModel)]="editingApartment.bathrooms">
            </div>
            
            <div class="form-group">
              <label>Square Footage:</label>
              <input type="number" [(ngModel)]="editingApartment.squareFootage">
            </div>
            
            <div class="form-group">
              <label>Price ($):</label>
              <input type="number" step="0.01" [(ngModel)]="editingApartment.price">
            </div>
            
            <div class="form-group">
              <label>Area:</label>
              <select [(ngModel)]="editingApartment.area">
                <option value="">Select area</option>
                <option *ngFor="let area of availableAreas" [value]="area">{{ area }}</option>
              </select>
            </div>
          </div>
          
          <div class="property-attributes">
            <h4>Property Attributes</h4>
            <div class="checkbox-group">
              <label>
                <input type="checkbox" [(ngModel)]="editingApartment.furnished">
                Furnished
              </label>
              <label>
                <input type="checkbox" [(ngModel)]="editingApartment.roomtorent">
                Room to rent
              </label>
              <label>
                <input type="checkbox" [(ngModel)]="editingApartment.condorentals">
                Condo Rentals
              </label>
              <label>
                <input type="checkbox" [(ngModel)]="editingApartment.available">
                Available
              </label>
            </div>
          </div>
          
          <div class="property-attributes">
            <h4>Amenities</h4>
            <div class="amenities-list">
              <label *ngFor="let toggle of availableToggles" class="amenity-item">
                <input 
                  type="checkbox" 
                  [checked]="isFeatureSelected(toggle)"
                  (change)="toggleFeature(toggle)">
                <span>{{ toggle }}</span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Details Tab -->
        <div class="tab-content" *ngIf="activeTab === 'details'">
          <div class="form-group">
            <label>Description (French):</label>
            <textarea rows="8" [(ngModel)]="editingApartment.description"></textarea>
          </div>
          
          <div class="form-group">
            <label>Description (English):</label>
            <textarea rows="8" [(ngModel)]="editingApartment.descriptionEn"></textarea>
          </div>
        </div>
        
        <!-- Features Tab -->
        <div class="tab-content" *ngIf="activeTab === 'features'">
          <div class="features-drive-manager">
            <h3>Features Data Management</h3>
            <p>Manage your listings features data with Google Drive integration.</p>
            
            @if (googleDriveFolderUrl) {
              <div class="drive-actions">
                <div class="button-group">
                  <button class="btn btn-primary" (click)="exportFeaturesData()" title="Export Features data to local file">
                    üì§ Export from Features Manager
                  </button>
                  <button class="btn btn-success" (click)="openGoogleDriveToUpload()" title="Open Google Drive to upload exported file">
                    ‚¨ÜÔ∏è Put into SeguinDev Drive
                  </button>
                </div>
                <div class="button-group">
                  <button class="btn btn-primary" (click)="quickImportFromSeguinDev()" title="Download Features file from SeguinDev Google Drive">
                    üì• Get from SeguinDev Drive
                  </button>
                  <label class="btn btn-secondary" title="Import Features data from local file">
                    üìã Import to Features Manager
                    <input type="file" accept=".json" (change)="importFeaturesData($event)" style="display: none;">
                  </label>
                </div>
              </div>
            } @else {
              <div class="drive-actions">
                <button class="btn btn-primary" (click)="exportFeaturesData()">
                  Export Features Data (JSON)
                </button>
                <label class="btn btn-secondary">
                  Import Features Data (JSON)
                  <input type="file" accept=".json" (change)="importFeaturesData($event)" style="display: none;">
                </label>
              </div>
            }
            
            <div class="info-panel">
              <h4>About Features Data</h4>
              <p><strong>Export:</strong> Download all apartment listings with features as a JSON file to your computer.</p>
              <p><strong>Import:</strong> Upload a previously exported JSON file to restore or update your features data.</p>
              <p><strong>‚ö†Ô∏è Warning:</strong> Importing will replace your current data. Export first if you want to keep your current data!</p>
            </div>
          </div>
        </div>
        
        <!-- Images Tab -->
        <div class="tab-content" *ngIf="activeTab === 'images'">
          <div class="image-upload">
            <div class="form-group">
              <label>Add Image URL:</label>
              <div class="input-with-button">
                <input 
                  type="text" 
                  [(ngModel)]="newImageUrl" 
                  placeholder="Enter image URL"
                  (keyup.enter)="addImage()">
                <button class="btn btn-success" (click)="addImage()">Add Image</button>
              </div>
            </div>
            
            <div class="form-group">
              <label>Or Upload from Computer:</label>
              <div class="file-upload-wrapper">
                <label class="btn btn-primary file-upload-btn">
                  Browse Files...
                  <input 
                    type="file" 
                    accept="image/*" 
                    multiple
                    (change)="onFileSelected($event)" 
                    style="display: none;">
                </label>
                <span class="file-info">Supports multiple image files (JPG, PNG, etc.)</span>
              </div>
            </div>
          </div>
          
          <div class="images-preview">
            <h4>Current Images ({{ editingApartment.images.length || 0 }})</h4>
            <div class="image-list">
              <div 
                *ngFor="let image of editingApartment.images; let i = index" 
                class="image-list-item">
                <span class="image-name">{{ image }}</span>
                <button class="btn btn-sm btn-danger" (click)="removeImage(i)">Remove</button>
              </div>
            </div>
            <div *ngIf="!editingApartment.images || editingApartment.images.length === 0" class="no-images">
              No images added yet
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeEditModal()">Cancel</button>
        <button class="btn btn-primary" (click)="saveEdit()">Save Changes</button>
      </div>
    </div>
  </div>
</div>
